<!DOCTYPE html>
<html>
<head>
    <title>üîß Stripe Dev3 Redirect Verification</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .result { margin: 15px 0; padding: 15px; border-radius: 6px; border: 1px solid #ddd; }
        .success { background: #e8f5e8; border-color: #4caf50; color: #2e7d32; }
        .error { background: #ffebee; border-color: #f44336; color: #c62828; }
        .warning { background: #fff3e0; border-color: #ff9800; color: #e65100; }
        .info { background: #e3f2fd; border-color: #2196f3; color: #1565c0; }
        button { padding: 12px 24px; margin: 8px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; }
        .btn-primary { background: #2196f3; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-secondary { background: #757575; color: white; }
        pre { background: #f5f5f5; padding: 15px; overflow-x: auto; border-radius: 4px; font-size: 12px; }
        .step { margin: 20px 0; }
        .step h3 { margin: 0 0 10px 0; color: #333; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-pending { background: #ff9800; }
        .status-success { background: #4caf50; }
        .status-error { background: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Stripe Dev3 Redirect Verification</h1>
        
        <div class="result info">
            <strong>Current Context:</strong><br>
            URL: <code id="current-url"></code><br>
            Origin: <code id="current-origin"></code><br>
            Expected: Should contain "dev3" and "netlify.app"
        </div>

        <div class="step">
            <h3><span class="status-indicator status-pending" id="debug-status"></span>Step 1: Test Debug Endpoint</h3>
            <p>Verify that the baseUrl resolver returns the correct dev3 URL</p>
            <button class="btn-primary" onclick="testDebugEndpoint()">Test Debug Endpoint</button>
            <div id="debug-result"></div>
        </div>

        <div class="step">
            <h3><span class="status-indicator status-pending" id="checkout-status"></span>Step 2: Create Fresh Checkout Session</h3>
            <p>Create a new Stripe session and verify it uses dev3 URLs (check console logs)</p>
            <button class="btn-primary" onclick="createFreshCheckout()">Create Fresh Checkout</button>
            <div id="checkout-result"></div>
        </div>

        <div class="step">
            <h3><span class="status-indicator status-pending" id="verify-status"></span>Step 3: Network Verification</h3>
            <p>Check browser Network tab to confirm function calls use relative paths</p>
            <button class="btn-secondary" onclick="openDevTools()">Open DevTools & Check Network</button>
        </div>

        <div class="step">
            <h3>üìã Manual Verification Checklist</h3>
            <ul>
                <li>‚úÖ Debug endpoint returns dev3 baseUrl</li>
                <li>‚è≥ Fresh checkout session created successfully</li>
                <li>‚è≥ Browser console shows [checkout] baseUrl with dev3</li>
                <li>‚è≥ Network tab shows relative function paths</li>
                <li>‚è≥ Stripe Dashboard shows success_url with dev3 domain</li>
                <li>‚è≥ Test payment redirects to dev3 success page</li>
            </ul>
        </div>
    </div>

    <script>
        // Display current context
        document.getElementById('current-url').textContent = window.location.href;
        document.getElementById('current-origin').textContent = window.location.origin;

        function updateStatus(elementId, success) {
            const indicator = document.getElementById(elementId);
            if (success) {
                indicator.className = 'status-indicator status-success';
            } else {
                indicator.className = 'status-indicator status-error';
            }
        }

        async function testDebugEndpoint() {
            const resultDiv = document.getElementById('debug-result');
            resultDiv.innerHTML = '<div class="result warning">üîÑ Testing debug endpoint...</div>';
            
            try {
                console.log('üîç Testing debug endpoint...');
                const response = await fetch('/.netlify/functions/create-checkout-session?debug=1', {
                    method: 'GET'
                });
                
                const data = await response.json();
                console.log('Debug response:', data);
                
                const isDevUrl = data.baseUrl && data.baseUrl.includes('dev3') && data.baseUrl.includes('netlify.app');
                const isCorrectOrigin = data.baseUrl === window.location.origin;
                
                if (response.ok && isDevUrl && isCorrectOrigin) {
                    updateStatus('debug-status', true);
                    resultDiv.innerHTML = \`
                        <div class="result success">
                            <h4>‚úÖ Debug Endpoint Success!</h4>
                            <p><strong>Status:</strong> \${response.status}</p>
                            <p><strong>Base URL:</strong> \${data.baseUrl}</p>
                            <p><strong>Matches Origin:</strong> ‚úÖ YES</p>
                            <p><strong>Is Dev3:</strong> ‚úÖ YES</p>
                            <pre>\${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    \`;
                } else {
                    updateStatus('debug-status', false);
                    resultDiv.innerHTML = \`
                        <div class="result error">
                            <h4>‚ùå Debug Endpoint Issue</h4>
                            <p><strong>Status:</strong> \${response.status}</p>
                            <p><strong>Base URL:</strong> \${data.baseUrl || 'Not found'}</p>
                            <p><strong>Expected:</strong> \${window.location.origin}</p>
                            <p><strong>Is Dev3:</strong> \${isDevUrl ? '‚úÖ' : '‚ùå'}</p>
                            <p><strong>Matches Origin:</strong> \${isCorrectOrigin ? '‚úÖ' : '‚ùå'}</p>
                            <pre>\${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    \`;
                }
            } catch (error) {
                updateStatus('debug-status', false);
                console.error('Debug endpoint error:', error);
                resultDiv.innerHTML = \`
                    <div class="result error">
                        <h4>‚ùå Debug Endpoint Error</h4>
                        <p>\${error.message}</p>
                    </div>
                \`;
            }
        }

        async function createFreshCheckout() {
            const resultDiv = document.getElementById('checkout-result');
            resultDiv.innerHTML = '<div class="result warning">üîÑ Creating fresh checkout session...</div>';
            
            try {
                console.log('üí≥ Creating fresh checkout session...');
                const response = await fetch('/.netlify/functions/create-checkout-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        intendedTier: 'Founding Member',
                        email: 'test-dev3@example.com',
                        assessmentId: 'test-dev3-' + Date.now()
                    })
                });
                
                const data = await response.json();
                console.log('Checkout response:', data);
                
                if (response.ok && data.url) {
                    updateStatus('checkout-status', true);
                    resultDiv.innerHTML = \`
                        <div class="result success">
                            <h4>‚úÖ Checkout Session Created!</h4>
                            <p><strong>Stripe URL:</strong> <a href="\${data.url}" target="_blank">Open Stripe Checkout</a></p>
                            <p><strong>Session ID:</strong> \${data.url.split('/').pop()}</p>
                            <pre>\${JSON.stringify(data, null, 2)}</pre>
                            <div style="margin-top: 15px; padding: 10px; background: #e8f4fd; border-radius: 4px;">
                                <strong>Next:</strong> Check browser console for "[checkout] baseUrl" log with dev3 URL.<br>
                                <strong>Then:</strong> Check Stripe Dashboard ‚Üí Events for success_url confirmation.
                            </div>
                        </div>
                    \`;
                } else {
                    updateStatus('checkout-status', false);
                    resultDiv.innerHTML = \`
                        <div class="result error">
                            <h4>‚ùå Checkout Session Failed</h4>
                            <p><strong>Status:</strong> \${response.status}</p>
                            <p><strong>Error:</strong> \${data.error || 'Unknown error'}</p>
                            <pre>\${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    \`;
                }
            } catch (error) {
                updateStatus('checkout-status', false);
                console.error('Checkout error:', error);
                resultDiv.innerHTML = \`
                    <div class="result error">
                        <h4>‚ùå Checkout Error</h4>
                        <p>\${error.message}</p>
                    </div>
                \`;
            }
        }

        function openDevTools() {
            alert('1. Press F12 to open DevTools\\n2. Go to Network tab\\n3. Clear existing requests\\n4. Test the checkout flow\\n5. Verify all .netlify/functions calls use relative paths');
        }

        // Auto-run debug test on page load
        window.onload = () => {
            setTimeout(testDebugEndpoint, 1000);
        };
    </script>
</body>
</html>